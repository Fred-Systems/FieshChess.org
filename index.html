<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FieshChess V2.0</title>
    
    <!-- PWA MANIFEST LINK (Required for APK) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#262421">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #161512;
            --bg-panel: #262421;
            --accent: #3b82f6;
            --board-light: #ebecd0;
            --board-dark: #779556;
            --app-scale: 1;
            --board-scale: 500px;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(var(--app-scale));
            transform-origin: top center;
        }

        #board-wrapper {
            width: var(--board-scale);
            max-width: 95vw;
            margin: 0 auto;
            position: relative;
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 4px solid var(--bg-panel);
            position: relative;
        }

        .square {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .square.light { background-color: var(--board-light); }
        .square.dark { background-color: var(--board-dark); }
        .square.selected { background-color: rgba(59, 130, 246, 0.7) !important; }
        .square.last-move { background-color: rgba(255, 255, 0, 0.3) !important; }
        
        .square.valid-move::after {
            content: "";
            width: 20%;
            height: 20%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
        }

        .piece {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
            pointer-events: none;
        }

        .blindfold .piece { opacity: 0 !important; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        .tab-active { border-bottom: 2px solid var(--accent); color: var(--accent); }
        
        #commentary-bubble {
            position: absolute;
            top: -45px;
            left: 0;
            right: 0;
            z-index: 60;
            pointer-events: none;
            display: none;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- First Time Setup Modal -->
    <div id="first-time-modal" class="modal-overlay hidden">
        <div class="bg-[#262421] p-8 rounded-xl border border-white/10 max-w-md w-full space-y-6">
            <h2 class="text-2xl font-black italic text-blue-500 uppercase text-center">Initial Setup</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-500">App Resolution</label>
                    <select id="initial-res" class="w-full bg-black/40 p-3 rounded mt-1">
                        <option value="0.6">Super Tiny</option>
                        <option value="0.7">Tiny</option>
                        <option value="0.85">Small</option>
                        <option value="1" selected>Medium</option>
                        <option value="1.15">Large</option>
                        <option value="1.3">Extra Large</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-500">Board Size</label>
                    <input type="range" id="initial-board" min="300" max="800" value="500" class="w-full accent-blue-600">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-500">Theme Preference</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <button onclick="updateTheme('classic')" class="bg-[#779556] p-2 rounded text-[10px] font-bold">Green</button>
                        <button onclick="updateTheme('blue')" class="bg-[#8ca2ad] p-2 rounded text-[10px] font-bold">Blue</button>
                    </div>
                </div>
            </div>
            <button onclick="finishSetup()" class="w-full bg-blue-600 py-4 rounded font-black uppercase tracking-widest">Launch Chess</button>
        </div>
    </div>

    <header class="bg-[#262421] px-4 py-2 flex items-center justify-between border-b border-white/5 shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-fish text-blue-500 text-xl"></i>
            <h1 class="font-bold text-xs tracking-tight uppercase">FieshChess V2.0</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSidebar('feedback')" class="p-2 bg-white/5 rounded hover:bg-white/10 text-pink-400"><i class="fa-solid fa-comment-dots"></i></button>
            <button onclick="toggleSidebar('config')" class="p-2 bg-white/5 rounded hover:bg-white/10"><i class="fa-solid fa-sliders"></i></button>
            <button onclick="toggleSidebar('book')" class="p-2 bg-white/5 rounded text-orange-400 hover:bg-white/10"><i class="fa-solid fa-book-open"></i></button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        <!-- Game Area -->
        <div class="flex-1 flex flex-col items-center p-2 overflow-y-auto">
            <div class="w-full max-w-[500px] flex items-center justify-between mb-1 px-1">
                <div id="eval-score" class="text-xl font-black tabular-nums">+0.0</div>
                <div class="flex gap-2">
                    <button onclick="flipBoard()" class="text-xs text-gray-500 hover:text-white"><i class="fa-solid fa-repeat"></i> FLIP</button>
                    <div id="best-move-hint" class="text-[10px] font-bold text-blue-400 hidden uppercase">BEST: --</div>
                </div>
            </div>

            <div id="board-wrapper">
                <div id="commentary-bubble" class="bg-blue-600 p-2 rounded text-center shadow-xl border border-white/20">
                    <p id="commentary-text" class="text-[10px] italic font-bold"></p>
                </div>
                <div id="board" class="chess-board"></div>
            </div>

            <div class="w-full max-w-[500px] grid grid-cols-4 gap-1 mt-2">
                <button onclick="navigateGame('start')" class="bg-white/5 p-2 rounded hover:bg-white/10"><i class="fa-solid fa-angles-left"></i></button>
                <button onclick="navigateGame('prev')" class="bg-white/5 p-2 rounded hover:bg-white/10"><i class="fa-solid fa-chevron-left"></i></button>
                <button onclick="navigateGame('next')" class="bg-white/5 p-2 rounded hover:bg-white/10"><i class="fa-solid fa-chevron-right"></i></button>
                <button onclick="resetGame()" class="bg-red-500/10 text-red-500 p-2 rounded hover:bg-red-500/20"><i class="fa-solid fa-rotate"></i></button>
            </div>

            <div class="w-full max-w-[500px] mt-2 flex gap-1">
                <button onclick="startGameReview('quick')" class="flex-1 bg-blue-600/20 text-blue-400 py-2 rounded text-[9px] font-black uppercase">Quick Review</button>
                <button onclick="stopDuel('none')" class="flex-1 bg-red-600/20 text-red-400 py-2 rounded text-[9px] font-black uppercase">Stop Engine</button>
                <button onclick="startGameReview('deep')" class="flex-1 bg-purple-600/20 text-purple-400 py-2 rounded text-[9px] font-black uppercase">Deep Review</button>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div id="side-panel" class="w-full md:w-[380px] bg-[#262421] flex flex-col border-l border-white/5">
            <div class="flex border-b border-white/5 shrink-0">
                <button onclick="switchTab('moves')" id="tab-moves" class="flex-1 py-3 text-[10px] font-black uppercase tab-active">Moves</button>
                <button onclick="switchTab('tools')" id="tab-tools" class="flex-1 py-3 text-[10px] font-black uppercase">Toolbox</button>
                <button onclick="switchTab('import')" id="tab-import" class="flex-1 py-3 text-[10px] font-black uppercase">Search</button>
                <button onclick="toggleCompactMode()" class="px-4 border-l border-white/5 text-gray-500"><i class="fa-solid fa-list-ol"></i></button>
            </div>

            <div id="content-moves" class="flex-1 overflow-y-auto p-3 custom-scroll">
                <div id="move-history"></div>
            </div>

            <div id="content-tools" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-500 uppercase">Load FEN (Initial Setup)</label>
                    <input id="fen-setup" type="text" class="w-full bg-black/40 border border-white/10 rounded p-2 text-xs" placeholder="FEN string...">
                    <button onclick="loadCustomFEN()" class="w-full bg-blue-600 py-2 rounded text-[10px] font-bold">SET POSITION</button>
                </div>
                <div class="space-y-2 border-t border-white/5 pt-4">
                    <label class="text-[10px] font-black text-gray-500 uppercase">PGN System</label>
                    <textarea id="pgn-input" class="w-full bg-black/40 border border-white/10 rounded p-2 text-[10px] h-24 font-mono" placeholder="Paste PGN..."></textarea>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="importPGN()" class="bg-blue-600 py-2 rounded text-[10px] font-bold">IMPORT</button>
                        <button onclick="copyPGN()" class="bg-white/10 py-2 rounded text-[10px] font-bold">COPY PGN</button>
                    </div>
                </div>
            </div>

            <div id="content-import" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex gap-2">
                    <input id="search-username" type="text" placeholder="Chess.com Username..." class="flex-1 bg-black/40 border border-white/10 rounded px-3 py-2 text-xs">
                    <button onclick="getProfile()" class="bg-blue-600 px-4 rounded text-xs font-bold">SEARCH</button>
                </div>
                <div id="profile-card" class="hidden p-3 bg-black/60 border border-white/10 rounded-lg space-y-3"></div>
                <div id="game-list" class="space-y-1"></div>
                <button id="btn-more" onclick="fetchMoreGames()" class="hidden w-full bg-white/5 py-2 rounded text-[9px] font-black uppercase">Load 20 More</button>
            </div>
        </div>
    </main>

    <!-- Review Modal -->
    <div id="review-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm space-y-4">
            <h3 class="text-xl font-black italic uppercase text-blue-500">Analysing Engine...</h3>
            <div class="w-full bg-white/10 h-2 rounded-full overflow-hidden">
                <div id="review-progress" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <p id="review-status" class="text-xs text-gray-400 font-mono">Position 0 / 0</p>
            <div class="flex gap-2">
                <button onclick="stopReview()" class="flex-1 bg-orange-600 py-2 rounded text-[10px] font-bold">STOP</button>
                <button onclick="cancelReview()" class="flex-1 bg-red-600 py-2 rounded text-[10px] font-bold">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div id="overlay-config" class="hidden fixed inset-0 z-[100] bg-black/95 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-black italic uppercase text-blue-500">System Config</h2>
            <button onclick="toggleSidebar('config')" class="text-2xl">&times;</button>
        </div>
        
        <div class="grid grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-gray-500 uppercase">App Resolution</label>
                    <select id="config-res" onchange="updateScale(this.value)" class="w-full bg-white/5 p-2 rounded text-xs">
                        <option value="0.6">Super Tiny</option>
                        <option value="0.7">Tiny</option>
                        <option value="0.85">Small</option>
                        <option value="1" selected>Medium</option>
                        <option value="1.15">Large</option>
                        <option value="1.3">Extra Large</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-gray-500 uppercase">Board Scaling</label>
                    <input type="range" min="300" max="800" value="500" oninput="updateBoardSize(this.value)" class="w-full accent-blue-600">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-gray-500 uppercase">Board Style</label>
                    <select onchange="updateTheme(this.value)" class="w-full bg-white/5 p-2 rounded text-xs">
                        <option value="classic">Green</option>
                        <option value="wood">Wood</option>
                        <option value="blue">Blue</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-gray-500 uppercase">Piece Set</label>
                    <select onchange="updatePieces(this.value)" class="w-full bg-white/5 p-2 rounded text-xs">
                        <option value="neo">Neo</option>
                        <option value="wood">Wood</option>
                        <option value="3d-wood">3D Wood</option>
                        <option value="club">Club</option>
                        <option value="glass">Glass</option>
                    </select>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex items-center justify-between p-2 bg-white/5 rounded">
                    <label class="text-[9px] font-black text-gray-500 uppercase">Blindfold</label>
                    <input type="checkbox" onchange="toggleBlindfold(this.checked)" class="w-4 h-4 accent-blue-600">
                </div>
                <div class="flex items-center justify-between p-2 bg-white/5 rounded">
                    <label class="text-[9px] font-black text-gray-500 uppercase">Engine Lines</label>
                    <input type="checkbox" id="toggle-hints" onchange="toggleHints(this.checked)" class="w-4 h-4 accent-blue-600">
                </div>
                <div class="flex items-center justify-between p-2 bg-white/5 rounded">
                    <label class="text-[9px] font-black text-gray-500 uppercase">Chess960</label>
                    <input type="checkbox" id="toggle-960" onchange="resetGame()" class="w-4 h-4 accent-blue-600">
                </div>
                <div class="p-2 bg-white/5 rounded space-y-2">
                    <label class="text-[9px] font-black text-gray-500 uppercase block">Commentary Toggles</label>
                    <div class="flex gap-4">
                        <label class="text-[8px] flex items-center gap-1"><input type="checkbox" id="mute-white" class="accent-blue-600"> WHITE</label>
                        <label class="text-[8px] flex items-center gap-1"><input type="checkbox" id="mute-black" class="accent-blue-600"> BLACK</label>
                    </div>
                </div>
                <div class="p-2 bg-white/5 rounded space-y-1">
                    <label class="text-[9px] font-black text-gray-500 uppercase block">Stockfish Elo</label>
                    <select id="engine-elo" class="w-full bg-black/40 text-[10px] p-1 rounded">
                        <option value="800">800 (Beginner)</option>
                        <option value="1200">1200 (Intermediate)</option>
                        <option value="1800">1800 (Expert)</option>
                        <option value="2500" selected>2500 (Grandmaster)</option>
                        <option value="3200">MAX (Stockfish 16)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-white/10 grid grid-cols-2 gap-4">
            <div class="space-y-2">
                <label class="text-[9px] font-black text-gray-500 uppercase">White Personality</label>
                <div id="p1-list" class="grid grid-cols-1 gap-1"></div>
            </div>
            <div class="space-y-2">
                <label class="text-[9px] font-black text-gray-500 uppercase">Black Personality</label>
                <div id="p2-list" class="grid grid-cols-1 gap-1"></div>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button onclick="startDuel('user')" class="flex-1 bg-blue-600 py-3 rounded font-black text-[10px]">PLAY VS ENGINE</button>
            <button onclick="startDuel('engine')" class="flex-1 bg-orange-600 py-3 rounded font-black text-[10px]">ENGINE DUEL</button>
        </div>
    </div>

    <!-- Opening Book Overlay -->
    <div id="overlay-book" class="hidden fixed inset-0 z-[100] bg-[#161512] flex flex-col p-4">
        <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
            <h2 class="text-xs font-black uppercase text-orange-400">Opening Master</h2>
            <button onclick="toggleSidebar('book')" class="text-2xl">&times;</button>
        </div>
        <div id="book-content" class="flex-1 overflow-y-auto custom-scroll space-y-4"></div>
    </div>

    <!-- Feedback Overlay -->
    <div id="overlay-feedback" class="hidden fixed inset-0 z-[150] bg-black/95 p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-black italic uppercase text-pink-500">Feedback & Bugs</h2>
            <button onclick="toggleSidebar('feedback')" class="text-2xl">&times;</button>
        </div>
        <form action="https://formspree.io/f/xeeoyzvb" method="POST" class="max-w-md mx-auto space-y-4">
            <div>
                <label class="text-[9px] font-black text-gray-500 uppercase">Email</label>
                <input type="email" name="email" class="w-full bg-white/5 p-3 rounded text-sm border border-white/10" placeholder="your@email.com">
            </div>
            <div>
                <label class="text-[9px] font-black text-gray-500 uppercase">Issue Description</label>
                <textarea name="message" class="w-full bg-white/5 p-3 rounded text-sm border border-white/10 h-32" placeholder="Tell us what's wrong..."></textarea>
            </div>
            <button type="submit" class="w-full bg-pink-600 py-3 rounded font-black uppercase text-xs">Send Report</button>
        </form>
    </div>

    <footer class="bg-[#161512] py-2 border-t border-white/5 text-center shrink-0">
        <p class="text-[8px] text-gray-600 uppercase font-black tracking-[0.3em]">© <span id="year"></span> Fiesh Productions</p>
    </footer>

    <script>
        const THEMES = {
            classic: { light: '#ebecd0', dark: '#779556' },
            wood: { light: '#dec9ad', dark: '#9c6f44' },
            blue: { light: '#dee3e6', dark: '#8ca2ad' },
            dark: { light: '#70665f', dark: '#4c433e' }
        };

        const PERSONALITIES = {
            stockfish: { name: 'Stockfish', quotes: ["Optimal move found.", "Position is solid."] },
            ginger: { name: 'Ginger GM', quotes: ["Harry the H-pawn!", "Push it!", "Checkmate is coming!"] },
            bobby: { name: 'Bobby Fischer', quotes: ["I'm the best.", "Your position is crumbling.", "Pathetic."] },
            magnus: { name: 'Magnus', quotes: ["Just technique.", "I see the win.", "Simple."] },
            anish: { name: 'Anish Giri', quotes: ["Draw is a valid result.", "Checking my Instagram...", "That's a drawish line."] },
            trump: { name: 'Donald Trump', quotes: ["Huge move. The best move.", "The board is rigged.", "We're winning bigly."] },
            elon: { name: 'Elon Musk', quotes: ["Occam's razor.", "First principles chess.", "X-Chess is the future."] },
            shakespeare: { name: 'Shakespeare', quotes: ["To check or not to check.", "Parting is such sweet mate.", "Alas, poor Rook!"] }
        };

        let game = new Chess();
        let history = [game.fen()];
        let moveData = [];
        let viewIndex = -1;
        let engine = null;
        let selectedSq = null;
        let userColor = 'w';
        let duelMode = 'none';
        let whiteP = 'stockfish';
        let blackP = 'ginger';
        let pieceSet = 'neo';
        let isCompact = false;
        let fetchedMonths = 0;
        let reviewStop = false;

        document.getElementById('year').innerText = new Date().getFullYear();

        function finishSetup() {
            updateScale(document.getElementById('initial-res').value);
            updateBoardSize(document.getElementById('initial-board').value);
            document.getElementById('first-time-modal').classList.add('hidden');
            localStorage.setItem('fiesh-setup-v2', 'true');
        }

        function toggleSidebar(id) { document.getElementById('overlay-'+id).classList.toggle('hidden'); }
        function switchTab(t) { ['moves','tools','import'].forEach(x => { document.getElementById('content-'+x).classList.toggle('hidden', x!==t); document.getElementById('tab-'+x).classList.toggle('tab-active', x===t); }); }
        function toggleBlindfold(v) { document.getElementById('board').classList.toggle('blindfold', v); }
        function toggleHints(v) { document.getElementById('best-move-hint').classList.toggle('hidden', !v); }
        function toggleCompactMode() { isCompact = !isCompact; updateHistoryUI(); }
        
        function updateScale(v) { 
            document.documentElement.style.setProperty('--app-scale', v); 
            document.getElementById('config-res').value = v;
        }
        
        function updateBoardSize(v) { 
            document.documentElement.style.setProperty('--board-scale', v + 'px'); 
        }

        function flipBoard() {
            userColor = userColor === 'w' ? 'b' : 'w';
            initBoard();
        }

        function generate960FEN() {
            let pieces = ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'];
            while (true) {
                for (let i = pieces.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
                }
                const b1 = pieces.indexOf('b');
                const b2 = pieces.lastIndexOf('b');
                const r1 = pieces.indexOf('r');
                const r2 = pieces.lastIndexOf('r');
                const k = pieces.indexOf('k');
                if ((b1 % 2 !== b2 % 2) && (r1 < k && k < r2)) break;
            }
            const backrank = pieces.join('');
            return `${backrank}/pppppppp/8/8/8/8/PPPPPPPP/${backrank.toUpperCase()} w KQkq - 0 1`;
        }

        function initBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            const fen = viewIndex === -1 ? game.fen() : history[viewIndex];
            const displayGame = new Chess(fen);
            const grid = displayGame.board();
            const lastMove = displayGame.history({verbose:true}).pop();

            const rows = userColor === 'w' ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const cols = userColor === 'w' ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];

            rows.forEach(r => {
                cols.forEach(c => {
                    const sq = String.fromCharCode(97+c) + (8-r);
                    const el = document.createElement('div');
                    el.className = `square ${(r+c)%2===0 ? 'light' : 'dark'}`;
                    el.id = `sq-${sq}`;
                    el.onclick = () => handleSquare(sq);
                    if (lastMove && (lastMove.from === sq || lastMove.to === sq)) el.classList.add('last-move');
                    
                    const p = grid[r][c];
                    if (p) {
                        const img = document.createElement('div');
                        img.className = 'piece';
                        const themePath = pieceSet === '3d-wood' ? 'wood' : pieceSet;
                        img.style.backgroundImage = `url(https://images.chesscomfiles.com/chess-themes/pieces/${themePath}/150/${(p.color+p.type).toLowerCase()}.png)`;
                        if (pieceSet === '3d-wood') img.style.filter = "drop-shadow(2px 4px 2px rgba(0,0,0,0.5))";
                        el.appendChild(img);
                    }
                    boardEl.appendChild(el);
                });
            });
            updateHistoryUI();
            runEngine();
            fetchBook();
        }

        function handleSquare(sq) {
            if (viewIndex !== -1) { viewIndex = -1; initBoard(); return; }
            if (duelMode === 'user' && game.turn() !== userColor) return;
            if (duelMode === 'engine') return;

            if (selectedSq === sq) { clearHighlights(); selectedSq = null; return; }
            if (selectedSq) {
                const move = game.move({ from: selectedSq, to: sq, promotion: 'q' });
                if (move) { history.push(game.fen()); selectedSq = null; initBoard(); sayComment(); return; }
            }
            const moves = game.moves({ square: sq, verbose: true });
            if (moves.length > 0) {
                clearHighlights();
                selectedSq = sq;
                document.getElementById('sq-'+sq).classList.add('selected');
                moves.forEach(m => document.getElementById('sq-'+m.to).classList.add('valid-move'));
            } else { clearHighlights(); selectedSq = null; }
        }

        async function initEngine() {
            if (engine) engine.terminate();
            const res = await fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
            const blob = new Blob([await res.text()], { type: 'application/javascript' });
            engine = new Worker(URL.createObjectURL(blob));
            engine.onmessage = (e) => {
                const msg = e.data;
                if (msg.startsWith('info depth')) {
                    const score = msg.match(/score cp (-?\d+)/);
                    const mate = msg.match(/score mate (-?\d+)/);
                    if (score || mate) {
                        let cp = score ? parseInt(score[1]) : (parseInt(mate[1]) > 0 ? 10000 : -10000);
                        const displayFen = viewIndex === -1 ? game.fen() : history[viewIndex];
                        const displayTurn = displayFen.includes(' w ') ? 'w' : 'b';
                        if (displayTurn === 'b') cp = -cp;
                        const val = (cp / 100).toFixed(1);
                        document.getElementById('eval-score').innerText = mate ? `M${Math.abs(mate[1])}` : (val > 0 ? '+' : '') + val;
                    }
                    const pv = msg.match(/ pv (\w+)/);
                    if (pv) {
                        const san = moveByNotation(pv[1]);
                        document.getElementById('best-move-hint').innerText = `BEST: ${san}`;
                    }
                } else if (msg.startsWith('bestmove')) {
                    const best = msg.split(' ')[1];
                    if (duelMode === 'engine' || (duelMode === 'user' && game.turn() !== userColor)) {
                        if (best && best !== '(none)') {
                            if (game.history().length > 100 && game.in_draw()) {
                                stopDuel('none');
                                return;
                            }
                            game.move({ from: best.substring(0, 2), to: best.substring(2, 4), promotion: 'q' });
                            history.push(game.fen()); initBoard(); sayComment();
                        }
                    }
                }
            };
            engine.postMessage('uci');
            engine.postMessage('setoption name UCI_Chess960 value true');
        }

        function moveByNotation(moveStr) {
            const temp = new Chess(viewIndex === -1 ? game.fen() : history[viewIndex]);
            const m = temp.move({ from: moveStr.substring(0, 2), to: moveStr.substring(2, 4), promotion: 'q' });
            return m ? m.san : moveStr;
        }

        function runEngine() {
            if (!engine) return;
            const fen = viewIndex === -1 ? game.fen() : history[viewIndex];
            engine.postMessage(`position fen ${fen}`);
            engine.postMessage(`setoption name Skill Level value ${Math.floor(document.getElementById('engine-elo').value / 150)}`);
            engine.postMessage(`go depth 14`);
        }

        function startDuel(type) {
            duelMode = type;
            if (type !== 'none') toggleSidebar('config');
            if (type === 'engine') userColor = 'w';
            initBoard();
        }

        function stopDuel(type) {
            duelMode = 'none';
            initBoard();
        }

        function sayComment() {
            const turn = game.turn();
            if (turn === 'w' && document.getElementById('mute-white').checked) return;
            if (turn === 'b' && document.getElementById('mute-black').checked) return;
            
            const pKey = turn === 'w' ? whiteP : blackP;
            const p = PERSONALITIES[pKey];
            const b = document.getElementById('commentary-bubble');
            const t = document.getElementById('commentary-text');
            t.innerText = `${p.name}: ${p.quotes[Math.floor(Math.random()*p.quotes.length)]}`;
            b.style.display = 'block';
            setTimeout(() => { b.style.display = 'none'; }, 2500);
        }

        async function startGameReview(type) {
            const h = game.history();
            if (h.length === 0) return;
            reviewStop = false; moveData = [];
            document.getElementById('review-modal').classList.remove('hidden');
            const depth = type === 'quick' ? 8 : 16;
            const temp = new Chess();
            for (let i = 0; i < h.length; i++) {
                if (reviewStop) break;
                temp.move(h[i]);
                const res = await analyzePosition(temp.fen(), depth);
                moveData[i] = res;
                document.getElementById('review-progress').style.width = Math.round(((i+1)/h.length)*100)+'%';
                document.getElementById('review-status').innerText = `Position ${i+1} / ${h.length}`;
            }
            document.getElementById('review-modal').classList.add('hidden');
            updateHistoryUI();
        }

        function analyzePosition(fen, depth) {
            return new Promise((resolve) => {
                const sub = new Worker(URL.createObjectURL(new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');`], {type:'application/javascript'})));
                sub.postMessage('uci'); 
                sub.postMessage('setoption name UCI_Chess960 value true');
                sub.postMessage(`position fen ${fen}`); 
                sub.postMessage(`go depth ${depth}`);
                let score = "0.0", best = "--";
                sub.onmessage = (e) => {
                    if (e.data.startsWith('info depth')) {
                        const sMatch = e.data.match(/score cp (-?\d+)/);
                        if (sMatch) score = (parseInt(sMatch[1])/100).toFixed(1);
                        const pv = e.data.match(/ pv (\w+)/);
                        if (pv) {
                            const t = new Chess(fen);
                            const m = t.move({from:pv[1].substring(0,2), to:pv[1].substring(2,4), promotion:'q'});
                            best = m ? m.san : pv[1];
                        }
                    }
                    if (e.data.startsWith('bestmove')) { sub.terminate(); resolve({eval: score, best: best}); }
                };
            });
        }

        function stopReview() { reviewStop = true; }
        function cancelReview() { reviewStop = true; moveData = []; document.getElementById('review-modal').classList.add('hidden'); updateHistoryUI(); }

        function updateHistoryUI() {
            const box = document.getElementById('move-history');
            box.innerHTML = '';
            const moves = game.history();
            if (isCompact) {
                box.className = "flex flex-wrap gap-1";
                moves.forEach((m, i) => {
                    const el = document.createElement('div');
                    el.className = `p-1 text-[8px] font-bold rounded ${viewIndex === i+1 ? 'bg-blue-600' : 'bg-white/5'}`;
                    el.innerText = `${i%2===0 ? (Math.floor(i/2)+1)+'.' : ''}${m}`;
                    el.onclick = () => { viewIndex = i+1; initBoard(); };
                    box.appendChild(el);
                });
            } else {
                box.className = "space-y-1";
                moves.forEach((m, i) => {
                    const row = document.createElement('div');
                    const d = moveData[i];
                    row.className = `flex items-center justify-between p-2 rounded text-[10px] cursor-pointer ${viewIndex === i+1 ? 'bg-blue-600' : 'bg-white/5'}`;
                    row.innerHTML = `
                        <div class="flex gap-3">
                            <span class="opacity-30 w-4">${i%2===0 ? (Math.floor(i/2)+1)+'.' : ''}</span>
                            <span class="font-black w-10">${m}</span>
                            <span class="text-blue-400 font-mono">${d ? d.eval : ''}</span>
                        </div>
                        <span class="text-[8px] opacity-40 font-bold uppercase">${d ? 'BEST: '+d.best : ''}</span>
                    `;
                    row.onclick = () => { viewIndex = i+1; initBoard(); };
                    box.appendChild(row);
                });
            }
        }

        async function getProfile() {
            const user = document.getElementById('search-username').value;
            const card = document.getElementById('profile-card');
            card.classList.remove('hidden'); card.innerHTML = '<div class="loader mx-auto"></div>';
            try {
                const p = await fetch(`https://api.chess.com/pub/player/${user}`).then(r=>r.json());
                const s = await fetch(`https://api.chess.com/pub/player/${user}/stats`).then(r=>r.json());
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${p.avatar || 'https://www.chess.com/bundles/web/images/noavatar_150.fb668a91.gif'}" class="w-8 h-8 rounded">
                        <div>
                            <div class="font-black text-xs">${p.username}</div>
                            <div class="text-[7px] text-gray-500 uppercase">Joined: ${new Date(p.joined*1000).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <div class="bg-orange-600 p-1 rounded text-center"><div class="text-[6px] font-black">BULLET</div><div class="text-[10px] font-black">${s.chess_bullet?.last?.rating || '--'}</div></div>
                        <div class="bg-green-600 p-1 rounded text-center"><div class="text-[6px] font-black">BLITZ</div><div class="text-[10px] font-black">${s.chess_blitz?.last?.rating || '--'}</div></div>
                        <div class="bg-blue-600 p-1 rounded text-center"><div class="text-[6px] font-black">RAPID</div><div class="text-[10px] font-black">${s.chess_rapid?.last?.rating || '--'}</div></div>
                    </div>
                `;
                fetchedMonths = 0; fetchMoreGames();
            } catch(e) { card.innerHTML = "Not found."; }
        }

        async function fetchMoreGames() {
            const user = document.getElementById('search-username').value;
            const list = document.getElementById('game-list');
            if (fetchedMonths === 0) list.innerHTML = '';
            const date = new Date(); date.setMonth(date.getMonth() - fetchedMonths);
            for (let i=0; i<3; i++) {
                const y = date.getFullYear(); const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const res = await fetch(`https://api.chess.com/pub/player/${user}/games/${y}/${m}`);
                const data = await res.json();
                if (data.games) {
                    data.games.reverse().forEach(g => {
                        const b = document.createElement('button');
                        b.className = "w-full p-2 bg-white/5 rounded text-[8px] text-left hover:bg-white/10";
                        b.innerText = `${g.white.username} vs ${g.black.username} (${new Date(g.end_time*1000).toLocaleDateString()})`;
                        b.onclick = () => { game.load_pgn(g.pgn); syncHistory(); initBoard(); switchTab('moves'); };
                        list.appendChild(b);
                    });
                }
                date.setMonth(date.getMonth() - 1); fetchedMonths++;
            }
            document.getElementById('btn-more').classList.remove('hidden');
        }

        function syncHistory() {
            const moves = game.history({verbose:true}); const temp = new Chess(); history = [temp.fen()];
            moves.forEach(m => { temp.move(m); history.push(temp.fen()); }); viewIndex = -1;
        }

        function loadCustomFEN() {
            const f = document.getElementById('fen-setup').value;
            if (game.load(f)) { history = [game.fen()]; viewIndex = -1; initBoard(); switchTab('moves'); }
            else alert("Invalid FEN");
        }

        async function fetchBook() {
            const fen = viewIndex === -1 ? game.fen() : history[viewIndex];
            try {
                const res = await fetch(`https://explorer.lichess.ovh/masters?fen=${encodeURIComponent(fen)}&topGames=10`);
                const data = await res.json();
                const cont = document.getElementById('book-content');
                cont.innerHTML = '<div class="text-[9px] font-black text-gray-500 mb-2">THEORY CONTINUATIONS</div>';
                data.moves?.forEach(m => {
                    const d = document.createElement('div');
                    d.className = 'flex justify-between p-2 bg-white/5 rounded text-[10px] cursor-pointer hover:bg-blue-600/20';
                    d.innerHTML = `
                        <span class="font-black text-blue-400">${m.san}</span> 
                        <span class="flex gap-2">
                            <span class="text-green-500 font-bold">W:${m.white}</span>
                            <span class="text-gray-400 font-bold">D:${m.draws}</span>
                            <span class="text-red-500 font-bold">L:${m.black}</span>
                        </span>`;
                    d.onclick = () => { game.move(m.san); history.push(game.fen()); initBoard(); };
                    cont.appendChild(d);
                });
                cont.innerHTML += '<div class="text-[9px] font-black text-gray-500 mt-4 mb-2">CLICKABLE MASTER GAMES</div>';
                data.topGames?.forEach(tg => {
                    const b = document.createElement('button');
                    b.className = 'w-full p-2 bg-white/5 rounded text-[9px] text-left hover:bg-white/10 mb-1';
                    b.innerHTML = `<div class="font-bold">${tg.white.name} vs ${tg.black.name}</div><div class="text-orange-400">${tg.year} • ${tg.winner || 'Draw'}</div>`;
                    b.onclick = () => {
                        fetch(`https://lichess.org/game/export/${tg.id}`).then(r=>r.text()).then(pgn => {
                            game.load_pgn(pgn); syncHistory(); initBoard(); toggleSidebar('book');
                        });
                    };
                    cont.appendChild(b);
                });
            } catch(e){}
        }

        function buildPers() {
            [document.getElementById('p1-list'), document.getElementById('p2-list')].forEach((container, idx) => {
                container.innerHTML = '';
                Object.entries(PERSONALITIES).forEach(([k, p]) => {
                    const active = (idx === 0 ? whiteP : blackP) === k;
                    const b = document.createElement('button');
                    b.className = `p-2 text-[8px] font-black uppercase text-left rounded ${active ? 'bg-blue-600' : 'bg-white/5'}`;
                    b.innerText = p.name;
                    b.onclick = () => { if (idx === 0) whiteP = k; else blackP = k; buildPers(); };
                    container.appendChild(b);
                });
            });
        }

        function updateTheme(k) { document.documentElement.style.setProperty('--board-light', THEMES[k].light); document.documentElement.style.setProperty('--board-dark', THEMES[k].dark); initBoard(); }
        function updatePieces(k) { pieceSet = k; initBoard(); }
        function clearHighlights() { document.querySelectorAll('.square').forEach(s => s.classList.remove('selected', 'valid-move')); }
        
        function resetGame() { 
            const is960 = document.getElementById('toggle-960').checked;
            game = new Chess();
            if (is960) {
                const fen960 = generate960FEN();
                game.load(fen960);
                if (engine) engine.postMessage('setoption name UCI_Chess960 value true');
            } else {
                if (engine) engine.postMessage('setoption name UCI_Chess960 value false');
            }
            history = [game.fen()]; 
            moveData = []; 
            viewIndex = -1; 
            initBoard(); 
        }

        function navigateGame(d) {
            if (d === 'start') viewIndex = 0;
            else if (d === 'prev') viewIndex = Math.max(0, (viewIndex === -1 ? history.length - 1 : viewIndex) - 1);
            else { viewIndex++; if (viewIndex >= history.length) viewIndex = -1; }
            initBoard();
        }
        function importPGN() { if(game.load_pgn(document.getElementById('pgn-input').value)){ syncHistory(); initBoard(); switchTab('moves'); } else alert("Bad PGN"); }
        function copyPGN() { 
            const pgn = game.pgn();
            document.getElementById('pgn-input').value = pgn; 
            navigator.clipboard.writeText(pgn); 
        }

        // PWA SERVICE WORKER REGISTRATION (Kept at bottom for safety)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./pwabuilder-sw.js').then(reg => {
                    console.log('PWA Service Worker registered');
                }).catch(err => {
                    console.log('PWA Service Worker failed to register', err);
                });
            });
        }

        window.onload = () => { 
            if (!localStorage.getItem('fiesh-setup-v2')) {
                document.getElementById('first-time-modal').classList.remove('hidden');
            }
            initEngine(); 
            buildPers(); 
            initBoard(); 
        };
    </script>
</body>
</html>
